name: Build & Sign APK

on:
  push:
    branches: [ main, master ]

jobs:
  tutor-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install & Build Web
        run: |
          npm install
          npm run build

      - name: Setup Java & Android
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Android SDK (ensure build-tools)
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0


      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Release APK (capture log)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew clean assembleRelease --stacktrace 2>&1 | tee gradle.log

      - name: Verify apksigner and zipalign
        run: |
          echo "Listing build-tools directories"
          ls -la $ANDROID_SDK_ROOT/build-tools || true
          echo "Which apksigner and zipalign"
          which apksigner || true
          which zipalign || true
          if [ -f "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" ]; then
            echo "apksigner found at $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner"
            ls -la $ANDROID_SDK_ROOT/build-tools/34.0.0/
          fi

      - name: Set BUILD_TOOLS path and add to PATH for signing action
        run: |
          echo "Detecting installed build-tools version"
          SDK_ROOT=${ANDROID_SDK_ROOT:-$ANDROID_SDK_HOME:-$ANDROID_HOME:-$HOME/Android/Sdk}
          echo "ANDROID_SDK_ROOT=${SDK_ROOT}" >> $GITHUB_ENV
          if [ -d "$SDK_ROOT/build-tools" ]; then
            BUILD_TOOLS_VERSION=$(ls "$SDK_ROOT/build-tools" | sort -V | tail -n1)
            echo "BUILD_TOOLS_VERSION=$BUILD_TOOLS_VERSION" >> $GITHUB_ENV
            echo "$SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION" >> $GITHUB_PATH
            echo "Added $SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION to PATH"
          else
            echo "No build-tools directory found under $SDK_ROOT" >&2
            exit 1
          fi

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Upload Final APK
        uses: actions/upload-artifact@v4
        with:
          name: TutorMaster-Final
          path: android/app/build/outputs/apk/release/*-signed.apk

      - name: Upload Gradle Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-log
          path: android/gradle.log